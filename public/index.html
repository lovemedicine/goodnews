<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Article labels</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 48rem; margin: 0; padding: 1rem; }
    article { border-bottom: 1px solid #ddd; padding: 1rem 0; }
    article:last-child { border-bottom: none; }
    h2 { margin: 0 0 0.25rem 0; font-size: 1rem; font-weight: 600; }
    .feed { margin: 0; font-size: 0.875rem; color: #666; }
    .description { margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #444; line-height: 1.4; }
    .labels { margin-top: 0.5rem; font-size: 0.875rem; display: flex; align-items: center; gap: 0.5rem; flex-wrap: wrap; }
    .labels span { color: #666; }
    .human-btn { display: inline-flex; align-items: center; padding: 0.2rem 0.5rem; margin: 0; background: #fff; border: 1px solid #bbb; border-radius: 0.25rem; cursor: pointer; font-size: 0.875rem; }
    .human-btn:hover { border-color: #999; }
    .human-btn:has(input:checked) { border-color: #555; background: #f5f5f5; }
    .human-btn input { position: absolute; opacity: 0; pointer-events: none; }
    .human-btns { display: inline-flex; align-items: center; gap: 0.25rem; flex-wrap: wrap; }
    .saved { color: #0a0; font-size: 0.75rem; margin-left: 0.5rem; }
    .error { color: #c00; font-size: 0.75rem; margin-left: 0.5rem; }
    nav { margin-top: 1rem; display: flex; gap: 1rem; align-items: center; }
    nav button { padding: 0.25rem 0.5rem; }
    .loading { color: #666; }
  </style>
</head>
<body>
  <main id="content">
    <p class="loading">Loading…</p>
  </main>
  <nav id="pagination" style="display: none;">
    <button id="prev" disabled>Previous</button>
    <span id="page-info"></span>
    <button id="next">Next</button>
  </nav>

  <script>
    const HUMAN_LABELS = ["good", "bad", "neutral", "opinion", "essential", "other"];
    let currentPage = 1;

    function stripHtml(html) {
      const div = document.createElement("div");
      div.innerHTML = html;
      return div.textContent || div.innerText || "";
    }

    function renderArticle(article) {
      const articleEl = document.createElement("article");
      articleEl.dataset.id = article.id;

      const title = document.createElement("h2");
      title.textContent = article.title;
      articleEl.appendChild(title);

      const feed = document.createElement("p");
      feed.className = "feed";
      feed.textContent = article.feed_name ?? "";
      articleEl.appendChild(feed);

      if (article.description) {
        const desc = document.createElement("p");
        desc.className = "description";
        desc.textContent = stripHtml(article.description);
        articleEl.appendChild(desc);
      }

      const labelsRow = document.createElement("div");
      labelsRow.className = "labels";
      const aiSpan = document.createElement("span");
      aiSpan.innerHTML = `AI: <strong>${article.label ?? "—"}</strong>`;
      labelsRow.appendChild(aiSpan);
      const agreeCheckbox = document.createElement("input");
      agreeCheckbox.type = "checkbox";
      agreeCheckbox.checked = article.human_label === article.label && article.label != null;
      agreeCheckbox.title = "Set Human label to match AI";
      labelsRow.appendChild(agreeCheckbox);
      const labelWrap = document.createElement("span");
      labelWrap.className = "human-btns";
      labelWrap.innerHTML = "Human: ";
      const radioName = `human_${article.id}`;
      const nullBtn = document.createElement("label");
      nullBtn.className = "human-btn";
      nullBtn.innerHTML = `<input type="radio" name="${radioName}" value="">—`;
      labelWrap.appendChild(nullBtn);
      HUMAN_LABELS.forEach((opt) => {
        const btn = document.createElement("label");
        btn.className = "human-btn";
        btn.innerHTML = `<input type="radio" name="${radioName}" value="${opt}">${opt}`;
        labelWrap.appendChild(btn);
      });
      const radios = labelWrap.querySelectorAll("input[type=radio]");
      const current = article.human_label ?? "";
      radios.forEach((r) => { r.checked = r.value === current; });
      const status = document.createElement("span");
      status.className = "saved";
      labelWrap.appendChild(status);
      labelsRow.appendChild(labelWrap);
      articleEl.appendChild(labelsRow);

      function getSelectedHumanLabel() {
        const r = labelWrap.querySelector(`input[name="${radioName}"]:checked`);
        return r ? r.value : "";
      }

      async function saveHumanLabel(value) {
        status.textContent = "";
        status.className = "saved";
        try {
          const res = await fetch("/api/articles", {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ id: article.id, human_label: value }),
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.error || res.statusText);
          }
          status.textContent = "Saved";
          status.className = "saved";
        } catch (e) {
          status.textContent = e.message;
          status.className = "error";
        }
      }

      agreeCheckbox.addEventListener("change", async () => {
        const value = agreeCheckbox.checked && article.label ? article.label : "";
        radios.forEach((r) => { r.checked = r.value === value; });
        await saveHumanLabel(value);
      });

      radios.forEach((radio) => {
        radio.addEventListener("change", async () => {
          const value = getSelectedHumanLabel();
          agreeCheckbox.checked = value === article.label && article.label != null;
          await saveHumanLabel(value);
        });
      });

      return articleEl;
    }

    async function loadPage(page) {
      const content = document.getElementById("content");
      content.innerHTML = "<p class=\"loading\">Loading…</p>";

      const res = await fetch(`/api/articles?page=${page}&limit=100`);
      if (!res.ok) {
        content.innerHTML = `<p class="error">Failed to load articles</p>`;
        return;
      }

      const data = await res.json();
      content.innerHTML = "";
      data.articles.forEach((article) => content.appendChild(renderArticle(article)));

      const nav = document.getElementById("pagination");
      nav.style.display = "flex";
      document.getElementById("page-info").textContent =
        `Page ${data.page} of ${data.total_pages} (${data.total} total)`;
      document.getElementById("prev").disabled = data.page <= 1;
      document.getElementById("next").disabled = data.page >= data.total_pages;
      currentPage = data.page;
    }

    document.getElementById("prev").addEventListener("click", () => loadPage(currentPage - 1));
    document.getElementById("next").addEventListener("click", () => loadPage(currentPage + 1));

    loadPage(1);
  </script>
</body>
</html>
